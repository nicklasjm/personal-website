---
import { optimizedUrl, imageSrcSet } from "@/lib/sanity";
import type { Post } from "@/lib/sanity";

interface Props {
  post: Post;
}

const { post } = Astro.props;

const href =
  post.category === "links" && post.externalLink
    ? post.externalLink
    : `/feed/${post.slug.current}`;

const isExternal = post.category === "links" && post.externalLink;

const imageUrl = post.featuredImage
  ? optimizedUrl(post.featuredImage, 800, { height: 500, fit: "crop" })
  : null;

const imageSrcSetStr = post.featuredImage
  ? imageSrcSet(post.featuredImage, [400, 800, 1200], { fit: "crop" })
  : null;

const date = new Date(post.publishedAt).toLocaleDateString("en-DK", {
  day: "numeric",
  month: "short",
  year: "numeric",
});

// Collect all images for the expanded carousel
const expandImages: string[] = [];
if (post.featuredImage) {
  expandImages.push(
    optimizedUrl(post.featuredImage, 1200, { height: 750, fit: "crop" })
  );
}
if (post.bodyImages) {
  for (const img of post.bodyImages) {
    expandImages.push(
      optimizedUrl(img, 1200, { height: 750, fit: "crop" })
    );
  }
}
if (post.galleries) {
  for (const gallery of post.galleries) {
    if (gallery.images) {
      for (const img of gallery.images) {
        expandImages.push(
          optimizedUrl(img, 1200, { height: 750, fit: "crop" })
        );
      }
    }
  }
}

const hasExpandContent = expandImages.length > 0 || post.excerpt;
---

<article class="post-card hover-lift animate-in">
  <a
    href={href}
    class="post-card-link"
    target={isExternal ? "_blank" : undefined}
    rel={isExternal ? "noopener noreferrer" : undefined}
  >
    {imageUrl && (
      <div class="post-card-media">
        <img
          src={imageUrl}
          srcset={imageSrcSetStr || undefined}
          sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 400px"
          alt={post.featuredImage?.alt || post.title}
          loading="lazy"
          decoding="async"
          class="post-card-image"
        />
      </div>
    )}
    <div class="post-card-info">
      <h3 class="post-card-title">{post.title}</h3>
      <div class="post-card-meta">
        <span class="post-card-category">{post.category}</span>
        <span class="post-card-date">{date}</span>
        {isExternal && <span class="post-card-external" aria-label="External link">&nearr;</span>}
      </div>
    </div>
  </a>
  {hasExpandContent && (
    <button
      class="post-expand-toggle"
      type="button"
      aria-label="Expand post"
      data-expand-images={JSON.stringify(expandImages)}
      data-expand-excerpt={post.excerpt || ""}
      data-expand-title={post.title}
      data-expand-href={href}
      data-expand-date={date}
      data-expand-category={post.category}
      data-expand-external={isExternal ? "true" : "false"}
    >
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="10 2 14 2 14 6" />
        <line x1="9" y1="7" x2="14" y2="2" />
        <polyline points="6 14 2 14 2 10" />
        <line x1="7" y1="9" x2="2" y2="14" />
      </svg>
    </button>
  )}
</article>

<style>
  .post-card {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .post-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .post-card-link:hover {
    color: inherit;
  }

  .post-card-media {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    border-radius: var(--radius-md);
    background: var(--color-bg-elevated);
  }

  .post-card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-out);
  }

  .post-card-link:hover .post-card-image {
    transform: scale(1.02);
  }

  .post-card-info {
    padding-top: var(--space-md);
  }

  .post-card-title {
    font-size: var(--text-base);
    font-weight: 500;
    line-height: var(--leading-normal);
    margin-bottom: var(--space-xs);
  }

  .post-card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .post-card-category {
    text-transform: capitalize;
  }

  .post-card-category::after {
    content: "·";
    margin-left: var(--space-sm);
  }

  .post-card-external {
    font-size: var(--text-sm);
  }

  /* Expand toggle — always visible */
  .post-expand-toggle {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: hsla(210, 25%, 97%, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    z-index: 3;
    cursor: pointer;
    transition:
      background-color var(--duration-fast) var(--ease-out),
      color var(--duration-fast) var(--ease-out),
      box-shadow var(--duration-fast) var(--ease-out);
  }

  .post-expand-toggle:hover {
    background: hsla(0, 0%, 100%, 0.95);
    color: var(--color-text-primary);
    box-shadow: var(--shadow-md);
  }

  .post-expand-toggle:active {
    transform: scale(0.95);
  }
</style>
