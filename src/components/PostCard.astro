---
import { urlFor, getFileUrl } from "@/lib/sanity";
import type { Post } from "@/lib/sanity";

interface Props {
  post: Post;
}

const { post } = Astro.props;

const href =
  post.category === "links" && post.externalLink
    ? post.externalLink
    : `/feed/${post.slug.current}`;

const isExternal = post.category === "links" && post.externalLink;

const imageUrl = post.featuredImage
  ? urlFor(post.featuredImage).width(800).height(500).auto("format").url()
  : null;

const videoUrl =
  post.featuredVideo?.asset?._ref
    ? getFileUrl(post.featuredVideo.asset._ref)
    : null;

const posterUrl = post.videoPoster
  ? urlFor(post.videoPoster).width(800).height(500).auto("format").url()
  : null;

const date = new Date(post.publishedAt).toLocaleDateString("en-DK", {
  day: "numeric",
  month: "short",
  year: "numeric",
});
---

<article class="post-card hover-lift animate-in">
  <a
    href={href}
    class="post-card-link"
    target={isExternal ? "_blank" : undefined}
    rel={isExternal ? "noopener noreferrer" : undefined}
  >
    {
      (imageUrl || videoUrl) && (
        <div class="post-card-media">
          {videoUrl ? (
            <div class="video-wrapper">
              <video
                src={videoUrl}
                poster={posterUrl || undefined}
                muted
                loop
                playsinline
                preload="none"
                class="post-card-video"
              />
            </div>
          ) : (
            <img
              src={imageUrl!}
              alt={post.featuredImage?.alt || post.title}
              loading="lazy"
              decoding="async"
              class="post-card-image"
            />
          )}
        </div>
      )
    }
    <div class="post-card-info">
      <h3 class="post-card-title">{post.title}</h3>
      <div class="post-card-meta">
        <span class="post-card-category">{post.category}</span>
        <span class="post-card-date">{date}</span>
        {isExternal && <span class="post-card-external" aria-label="External link">&nearr;</span>}
      </div>
    </div>
  </a>
</article>

<style>
  .post-card {
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .post-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .post-card-link:hover {
    color: inherit;
  }

  .post-card-media {
    position: relative;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    border-radius: var(--radius-md);
    background: var(--color-bg-elevated);
  }

  .post-card-image,
  .post-card-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-slow) var(--ease-out);
  }

  .post-card-link:hover .post-card-image,
  .post-card-link:hover .post-card-video {
    transform: scale(1.02);
  }

  .post-card-info {
    padding-top: var(--space-md);
  }

  .post-card-title {
    font-size: var(--text-base);
    font-weight: 500;
    line-height: var(--leading-normal);
    margin-bottom: var(--space-xs);
  }

  .post-card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .post-card-category {
    text-transform: capitalize;
  }

  .post-card-category::after {
    content: "Â·";
    margin-left: var(--space-sm);
  }

  .post-card-external {
    font-size: var(--text-sm);
  }
</style>

<script>
  // Autoplay video on hover
  document.querySelectorAll(".post-card .video-wrapper").forEach((wrapper) => {
    const video = wrapper.querySelector("video");
    if (!video) return;

    const card = wrapper.closest(".post-card");
    if (!card) return;

    card.addEventListener("mouseenter", () => {
      video.play().catch(() => {});
    });

    card.addEventListener("mouseleave", () => {
      video.pause();
      video.currentTime = 0;
    });
  });
</script>
