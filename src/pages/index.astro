---
import Base from "@/layouts/Base.astro";
import { getSettings, getAllPosts, optimizedUrl } from "@/lib/sanity";

const settings = await getSettings();
const heroText =
  settings?.heroText ||
  "Junior Digital Designer at Kontrapunkt in Copenhagen.\nFocusing on system design, optimization, and aesthetic design.";

// Build lightweight project data for the cursor feature
const allPosts = await getAllPosts();
const cursorProjects = allPosts
  .filter((p) => p.featuredImage)
  .map((p) => ({
    title: p.title,
    href:
      p.category === "links" && p.externalLink
        ? p.externalLink
        : `/feed/${p.slug.current}`,
    image: optimizedUrl(p.featuredImage!, 600, { height: 375, fit: "crop" }),
  }));
---

<Base bodyClass="page-home">
  <section class="hero" data-cursor-projects={JSON.stringify(cursorProjects)}>
    <div class="hero-content animate-in">
      <p class="hero-name">Nicklas Jakobsen</p>
      <p class="hero-text">{heroText}</p>
    </div>
  </section>

  <!-- Cursor follower — positioned via JS, hidden by default (desktop hover only) -->
  <div id="cursor-project" class="cursor-project" aria-hidden="true">
    <!-- Cursor arrow — shows current pointer position when system cursor is hidden -->
    <svg
      class="cursor-arrow"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 9 15"
      width="14"
      height="20"
      aria-hidden="true"
    >
      <path
        d="M0 0 L0 12 L3.5 9 L5.5 14 L7 13 L4.5 8 L8.5 8 Z"
        fill="currentColor"
        stroke="white"
        stroke-width="0.8"
        stroke-linejoin="round"
      ></path>
    </svg>
    <div class="cursor-project-image-wrap">
      <img class="cursor-project-image" src="" alt="" loading="eager" />
    </div>
    <span class="cursor-project-title"></span>
  </div>

  <!--
    Attached project card — shown in desktop safe zone (near bottom nav / theme toggle).
    Gives users a "normal" cursor + project preview when navigating to UI controls.
  -->
  <div id="attached-project" class="attached-project" aria-hidden="true">
    <div class="attached-project-image-wrap">
      <img class="attached-project-image" src="" alt="" loading="lazy" />
    </div>
    <span class="attached-project-title"></span>
  </div>

  <!--
    Mobile project card — shown on first touch / scroll on touch devices.
    Auto-cycles through projects every 3 s.
  -->
  <div id="mobile-project" class="mobile-project" aria-hidden="true">
    <div class="mobile-project-image-wrap">
      <img class="mobile-project-image" src="" alt="" loading="lazy" />
    </div>
    <span class="mobile-project-title"></span>
  </div>
</Base>

<style>
  .hero {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    padding: var(--grid-margin);
    padding-bottom: calc(var(--nav-height) + var(--nav-bottom-offset) + var(--space-2xl));
  }

  .hero-content {
    max-width: 480px;
    text-align: center;
  }

  .hero-name {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    letter-spacing: 0.02em;
    margin-bottom: var(--space-md);
  }

  .hero-text {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    white-space: pre-line;
  }

  /* ── Desktop cursor follower ────────────────────────────────────── */

  .cursor-project {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 50;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--duration-slow) var(--ease-out);
    will-change: left, top;
    display: flex;
    flex-direction: column;
  }

  .cursor-project.is-visible {
    opacity: 1;
  }

  /* Cursor arrow SVG — sits at the exact cursor position */
  .cursor-arrow {
    display: block;
    color: var(--color-text-primary);
    flex-shrink: 0;
    margin-bottom: 6px;
    /* White glow for visibility on any background */
    filter: drop-shadow(0 0 3px hsla(0, 0%, 100%, 0.9))
      drop-shadow(0 1px 4px hsla(0, 0%, 0%, 0.25));
  }

  .cursor-project-image-wrap {
    width: 200px;
    aspect-ratio: 16 / 10;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-bg-elevated);
    box-shadow: var(--shadow-lg);
  }

  .cursor-project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cursor-project-title {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-align: left;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ── Desktop attached project (safe zone) ───────────────────────── */

  .attached-project {
    position: fixed;
    bottom: calc(var(--nav-height) + var(--nav-bottom-offset) + var(--space-xl));
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-slow) var(--ease-out);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .attached-project.is-visible {
    opacity: 1;
    pointer-events: auto;
  }

  .attached-project-image-wrap {
    width: 180px;
    aspect-ratio: 16 / 10;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-bg-elevated);
    box-shadow: var(--shadow-lg);
    transition: transform var(--duration-fast) var(--ease-out);
  }

  .attached-project:hover .attached-project-image-wrap {
    transform: scale(1.03);
  }

  .attached-project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .attached-project-title {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-align: center;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ── Mobile project card ────────────────────────────────────────── */

  .mobile-project {
    position: fixed;
    bottom: calc(var(--nav-height) + var(--nav-bottom-offset) + var(--space-xl));
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--duration-slow) var(--ease-out);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .mobile-project.is-visible {
    opacity: 1;
    pointer-events: auto;
  }

  .mobile-project-image-wrap {
    width: 200px;
    aspect-ratio: 16 / 10;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-bg-elevated);
    box-shadow: var(--shadow-lg);
  }

  .mobile-project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .mobile-project-title {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-align: center;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ── Visibility rules per input method ──────────────────────────── */

  /* Hide cursor follower + attached project on touch/small screens */
  @media (hover: none), (max-width: 768px) {
    .cursor-project,
    .attached-project {
      display: none;
    }
  }

  /* Hide mobile card on pointer/hover-capable devices */
  @media (hover: hover) and (min-width: 769px) {
    .mobile-project {
      display: none;
    }
  }
</style>

<script>
  const hero = document.querySelector<HTMLElement>(".hero");
  const follower = document.getElementById("cursor-project");
  const attachedProject = document.getElementById("attached-project");

  if (hero && follower && window.matchMedia("(hover: hover)").matches) {
    const raw = hero.dataset.cursorProjects;
    const projects: { title: string; href: string; image: string }[] = raw ? JSON.parse(raw) : [];

    if (projects.length > 0) {
      const img = follower.querySelector<HTMLImageElement>(".cursor-project-image")!;
      const titleEl = follower.querySelector<HTMLElement>(".cursor-project-title")!;
      const attachedImg = attachedProject?.querySelector<HTMLImageElement>(".attached-project-image");
      const attachedTitleEl = attachedProject?.querySelector<HTMLElement>(".attached-project-title");

      // Shuffle (Fisher–Yates)
      for (let i = projects.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [projects[i], projects[j]] = [projects[j], projects[i]];
      }

      let currentIndex = 0;
      let distance = 0;
      let lastX = 0;
      let lastY = 0;
      let targetX = 0;
      let targetY = 0;
      let currentX = 0;
      let currentY = 0;
      let raf = 0;
      let isInHero = false;

      // Safe zone thresholds (px from viewport edge)
      const BOTTOM_SAFE_PX = 110; // covers nav + breathing room
      const CORNER_SAFE_PX = 80;  // top-right corner (theme toggle)

      function isInSafeZone(x: number, y: number): boolean {
        const fromBottom = window.innerHeight - y;
        const fromTop = y;
        const fromRight = window.innerWidth - x;
        return fromBottom < BOTTOM_SAFE_PX || (fromTop < CORNER_SAFE_PX && fromRight < CORNER_SAFE_PX);
      }

      function showProject(index: number) {
        const p = projects[index];
        img.src = p.image;
        titleEl.textContent = p.title;
        follower.dataset.href = p.href;
        // Keep attached card in sync
        if (attachedImg) attachedImg.src = p.image;
        if (attachedTitleEl) attachedTitleEl.textContent = p.title;
        if (attachedProject) attachedProject.dataset.href = p.href;
      }

      // Preload first project
      showProject(0);

      function lerp(a: number, b: number, t: number) {
        return a + (b - a) * t;
      }

      function animate() {
        currentX = lerp(currentX, targetX, 0.12);
        currentY = lerp(currentY, targetY, 0.12);
        follower.style.left = currentX + "px";
        follower.style.top = currentY + "px";

        if (isInHero) {
          raf = requestAnimationFrame(animate);
        }
      }

      hero.addEventListener("mouseenter", (e) => {
        // Snap to initial position (no lerp lag)
        currentX = targetX = e.clientX;
        currentY = targetY = e.clientY;
        lastX = e.clientX;
        lastY = e.clientY;
        follower.style.left = currentX + "px";
        follower.style.top = currentY + "px";

        isInHero = true;
        raf = requestAnimationFrame(animate);

        // Only hide system cursor / show follower when outside safe zone
        if (!isInSafeZone(e.clientX, e.clientY)) {
          hero.style.cursor = "none";
          follower.classList.add("is-visible");
        }
      });

      hero.addEventListener("mouseleave", () => {
        isInHero = false;
        hero.style.cursor = "";
        follower.classList.remove("is-visible");
        if (attachedProject) attachedProject.classList.remove("is-visible");
        cancelAnimationFrame(raf);
      });

      hero.addEventListener("mousemove", (e) => {
        targetX = e.clientX;
        targetY = e.clientY;

        const inSafe = isInSafeZone(e.clientX, e.clientY);

        if (inSafe) {
          // Restore cursor so user can click nav / theme toggle
          hero.style.cursor = "auto";
          follower.classList.remove("is-visible");

          // Show attached project only in the bottom safe zone (not top-right corner)
          const fromBottom = window.innerHeight - e.clientY;
          if (attachedProject) {
            if (fromBottom < BOTTOM_SAFE_PX) {
              attachedProject.classList.add("is-visible");
            } else {
              attachedProject.classList.remove("is-visible");
            }
          }
        } else {
          hero.style.cursor = "none";
          follower.classList.add("is-visible");
          if (attachedProject) attachedProject.classList.remove("is-visible");
        }

        // Track movement distance for cycling
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        distance += Math.sqrt(dx * dx + dy * dy);
        lastX = e.clientX;
        lastY = e.clientY;

        // Advance to next project every 300px of movement
        if (distance > 300) {
          distance = 0;
          currentIndex = (currentIndex + 1) % projects.length;
          showProject(currentIndex);
        }
      });

      // Click follower or attached project to navigate
      hero.addEventListener("click", (e) => {
        const inSafe = isInSafeZone(e.clientX, e.clientY);
        if (!inSafe) {
          const href = follower.dataset.href;
          if (href) window.location.href = href;
        }
      });

      attachedProject?.addEventListener("click", () => {
        const href = attachedProject.dataset.href;
        if (href) window.location.href = href;
      });
    }
  }

  // ── Mobile: show project card on first touch / scroll ─────────────────────
  const mobileCard = document.getElementById("mobile-project");

  if (mobileCard && !window.matchMedia("(hover: hover)").matches) {
    const raw = document.querySelector<HTMLElement>(".hero")?.dataset.cursorProjects;
    const projects: { title: string; href: string; image: string }[] = raw ? JSON.parse(raw) : [];

    if (projects.length > 0) {
      const mImg = mobileCard.querySelector<HTMLImageElement>(".mobile-project-image")!;
      const mTitle = mobileCard.querySelector<HTMLElement>(".mobile-project-title")!;

      // Shuffle
      for (let i = projects.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [projects[i], projects[j]] = [projects[j], projects[i]];
      }

      let idx = 0;

      function showMobile(index: number) {
        const p = projects[index];
        mImg.src = p.image;
        mTitle.textContent = p.title;
        mobileCard!.dataset.href = p.href;
      }

      // Preload first image before user interacts
      showMobile(0);

      let hasAppeared = false;
      let cycleTimer = 0;

      function appear() {
        if (hasAppeared) return;
        hasAppeared = true;
        mobileCard!.classList.add("is-visible");

        // Auto-cycle every 3 s using requestAnimationFrame-friendly timer
        cycleTimer = window.setInterval(() => {
          idx = (idx + 1) % projects.length;
          showMobile(idx);
        }, 3000);
      }

      // Passive listeners for performance — do not block scroll
      window.addEventListener("touchstart", appear, { passive: true, once: true });
      window.addEventListener("scroll", appear, { passive: true, once: true });

      mobileCard.addEventListener("click", () => {
        const href = mobileCard.dataset.href;
        if (href) window.location.href = href;
      });
    }
  }
</script>
