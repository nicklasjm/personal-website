---
import Base from "@/layouts/Base.astro";
import { getSettings, getAllPosts, optimizedUrl } from "@/lib/sanity";

const settings = await getSettings();
const heroText =
  settings?.heroText ||
  "Junior Digital Designer at Kontrapunkt in Copenhagen.\nFocusing on system design, optimization, and aesthetic design.";

// Build lightweight project data for the cursor/touch feature
const allPosts = await getAllPosts();
const cursorProjects = allPosts
  .filter((p) => p.featuredImage)
  .map((p) => ({
    title: p.title,
    href:
      p.category === "links" && p.externalLink
        ? p.externalLink
        : `/feed/${p.slug.current}`,
    image: optimizedUrl(p.featuredImage!, 600, { height: 375, fit: "crop" }),
  }));
---

<Base bodyClass="page-home">
  <section class="hero" data-cursor-projects={JSON.stringify(cursorProjects)}>
    <div class="hero-content animate-in">
      <p class="hero-name">Nicklas Jakobsen</p>
      <p class="hero-text">{heroText}</p>
    </div>
  </section>

  <!-- Project follower — hidden by default, positioned via JS with translate3d -->
  <div id="cursor-project" class="cursor-project" aria-hidden="true">
    <div class="cursor-project-image-wrap">
      <img class="cursor-project-image" src="" alt="" />
    </div>
    <span class="cursor-project-title"></span>
  </div>
</Base>

<style is:global>
  /* ── Project follower ──────────────────────────────────────────────
     Using is:global to guarantee styles apply regardless of Astro
     scoping on slotted content. See .cursor-trail-knowledge.md.
     ─────────────────────────────────────────────────────────────── */
  .cursor-project {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 50;
    pointer-events: none;
    will-change: transform;
    backface-visibility: hidden;

    /* Triple-layer hide: invisible before JS runs */
    opacity: 0;
    visibility: hidden;
    transform: translate3d(-9999px, -9999px, 0);

    transition:
      opacity 0.3s cubic-bezier(0.16, 1, 0.3, 1),
      visibility 0.3s;
  }

  .cursor-project.is-visible {
    opacity: 1;
    visibility: visible;
    /* transform is controlled by JS — don't set it here */
  }

  .cursor-project-image-wrap {
    width: 220px;
    aspect-ratio: 16 / 10;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-bg-elevated);
    box-shadow: var(--shadow-lg);
  }

  .cursor-project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cursor-project-title {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    text-align: center;
    max-width: 220px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Smaller card on mobile */
  @media (max-width: 768px) {
    .cursor-project-image-wrap {
      width: 160px;
    }
    .cursor-project-title {
      max-width: 160px;
    }
  }
</style>

<style>
  .hero {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100dvh;
    padding: var(--grid-margin);
    padding-bottom: calc(var(--nav-height) + var(--nav-bottom-offset) + var(--space-2xl));
  }

  .hero-content {
    max-width: 480px;
    text-align: center;
  }

  .hero-name {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    letter-spacing: 0.02em;
    margin-bottom: var(--space-md);
  }

  .hero-text {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    white-space: pre-line;
  }
</style>

<script>
  /**
   * Project preview follower — desktop (cursor) + mobile (touch).
   * See .cursor-trail-knowledge.md for rationale.
   *
   * Desktop: image follows mouse with lerp smoothing, cursor hidden.
   * Mobile:  image appears above touch point, tap navigates to project.
   *
   * Key decisions:
   * - translate3d for GPU compositing (never left/top)
   * - Lerp smoothing with idle detection on desktop
   * - Triple-layer CSS hide (opacity + visibility + off-screen transform)
   * - is:global styles to avoid Astro scoping issues on slotted elements
   */

  const hero = document.querySelector<HTMLElement>(".hero");
  const follower = document.getElementById("cursor-project");

  if (hero && follower) {
    const raw = hero.dataset.cursorProjects;
    const projects: { title: string; href: string; image: string }[] = raw
      ? JSON.parse(raw)
      : [];

    if (projects.length > 0) {
      const img = follower.querySelector<HTMLImageElement>(
        ".cursor-project-image",
      )!;
      const titleEl = follower.querySelector<HTMLElement>(
        ".cursor-project-title",
      )!;

      // Shuffle (Fisher–Yates)
      for (let i = projects.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [projects[i], projects[j]] = [projects[j], projects[i]];
      }

      let currentIndex = 0;
      let distance = 0;

      function showProject(index: number) {
        const p = projects[index];
        img.src = p.image;
        titleEl.textContent = p.title;
        follower.dataset.href = p.href;
      }

      function advanceProject() {
        currentIndex = (currentIndex + 1) % projects.length;
        showProject(currentIndex);
      }

      // Preload first project
      showProject(0);

      const isDesktop = window.matchMedia("(hover: hover)").matches;

      if (isDesktop) {
        // ── Desktop: cursor follower with lerp ───────────────────────
        let lastX = 0;
        let lastY = 0;
        let targetX = 0;
        let targetY = 0;
        let currentX = -9999;
        let currentY = -9999;
        let raf = 0;
        let isInHero = false;

        const SPEED = 0.12;
        const THRESHOLD = 0.5;

        function lerp(a: number, b: number, t: number) {
          return a + (b - a) * t;
        }

        function animate() {
          currentX = lerp(currentX, targetX, SPEED);
          currentY = lerp(currentY, targetY, SPEED);
          follower.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;

          const dx = Math.abs(targetX - currentX);
          const dy = Math.abs(targetY - currentY);

          if (isInHero && (dx > THRESHOLD || dy > THRESHOLD)) {
            raf = requestAnimationFrame(animate);
          } else if (isInHero) {
            currentX = targetX;
            currentY = targetY;
            follower.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
            raf = 0;
          }
        }

        hero.addEventListener("mouseenter", (e) => {
          currentX = targetX = e.clientX;
          currentY = targetY = e.clientY;
          lastX = e.clientX;
          lastY = e.clientY;
          distance = 0;
          follower.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;

          isInHero = true;
          follower.classList.add("is-visible");
          if (!raf) raf = requestAnimationFrame(animate);
        });

        hero.addEventListener("mouseleave", () => {
          isInHero = false;
          follower.classList.remove("is-visible");
          if (raf) {
            cancelAnimationFrame(raf);
            raf = 0;
          }
        });

        hero.addEventListener("mousemove", (e) => {
          targetX = e.clientX;
          targetY = e.clientY;

          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          distance += Math.sqrt(dx * dx + dy * dy);
          lastX = e.clientX;
          lastY = e.clientY;

          if (distance > 300) {
            distance = 0;
            advanceProject();
          }

          if (!raf && isInHero) {
            raf = requestAnimationFrame(animate);
          }
        });

        hero.addEventListener("click", () => {
          const href = follower.dataset.href;
          if (href) window.location.href = href;
        });

        hero.style.cursor = "none";
      } else {
        // ── Mobile: touch-based project preview ──────────────────────
        // Image appears offset above the touch point so the finger
        // doesn't obscure it. Each new touch cycles the project.
        // Lifting the finger navigates to the shown project.

        const OFFSET_Y = -180; // px above the touch point

        let touchActive = false;
        let touchTimer = 0;

        hero.addEventListener(
          "touchstart",
          (e) => {
            // Ignore if touch is on the hero-content text (let links work)
            const target = e.target as HTMLElement;
            if (target.closest("a")) return;

            const touch = e.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            // Position above the finger
            follower.style.transform = `translate3d(${x}px, ${y + OFFSET_Y}px, 0)`;
            follower.classList.add("is-visible");
            touchActive = true;

            // Cycle to next project on each new touch
            advanceProject();

            // Clear any pending hide timer
            clearTimeout(touchTimer);
          },
          { passive: true },
        );

        hero.addEventListener(
          "touchmove",
          (e) => {
            if (!touchActive) return;
            const touch = e.touches[0];
            follower.style.transform = `translate3d(${touch.clientX}px, ${touch.clientY + OFFSET_Y}px, 0)`;
          },
          { passive: true },
        );

        hero.addEventListener(
          "touchend",
          (e) => {
            if (!touchActive) return;
            touchActive = false;

            // Navigate to the shown project
            const href = follower.dataset.href;
            if (href) {
              window.location.href = href;
            }

            // Fade out after a short delay
            touchTimer = window.setTimeout(() => {
              follower.classList.remove("is-visible");
            }, 200);
          },
          { passive: true },
        );
      }
    }
  }
</script>
